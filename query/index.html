<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>查询 | sqala</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="类型安全的Scala3查询库">
    
    <link rel="preload" href="/sqala-doc/assets/css/0.styles.05ece7a7.css" as="style"><link rel="preload" href="/sqala-doc/assets/js/app.9bf302b3.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/2.58244656.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/1.6ba70183.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/28.83043ead.js" as="script"><link rel="prefetch" href="/sqala-doc/assets/js/10.0720960b.js"><link rel="prefetch" href="/sqala-doc/assets/js/11.2a97faa3.js"><link rel="prefetch" href="/sqala-doc/assets/js/12.6b9ed61d.js"><link rel="prefetch" href="/sqala-doc/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/sqala-doc/assets/js/14.3e65117c.js"><link rel="prefetch" href="/sqala-doc/assets/js/15.2d87bde7.js"><link rel="prefetch" href="/sqala-doc/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/sqala-doc/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/sqala-doc/assets/js/18.4c170722.js"><link rel="prefetch" href="/sqala-doc/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/sqala-doc/assets/js/20.10e47ab9.js"><link rel="prefetch" href="/sqala-doc/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/sqala-doc/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/sqala-doc/assets/js/23.cac91773.js"><link rel="prefetch" href="/sqala-doc/assets/js/24.28b07f74.js"><link rel="prefetch" href="/sqala-doc/assets/js/25.4285c857.js"><link rel="prefetch" href="/sqala-doc/assets/js/26.6bc8b23d.js"><link rel="prefetch" href="/sqala-doc/assets/js/27.d15bd4b2.js"><link rel="prefetch" href="/sqala-doc/assets/js/29.6f1587b4.js"><link rel="prefetch" href="/sqala-doc/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/sqala-doc/assets/js/4.45665f8a.js"><link rel="prefetch" href="/sqala-doc/assets/js/5.7098d77a.js"><link rel="prefetch" href="/sqala-doc/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/sqala-doc/assets/js/7.6a854e57.js"><link rel="prefetch" href="/sqala-doc/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/sqala-doc/assets/css/0.styles.05ece7a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqala-doc/" class="home-link router-link-active"><!----> <span class="site-name">sqala</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/sqala-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/sqala-doc/database/" class="sidebar-link">数据库交互</a></li><li><a href="/sqala-doc/query/" aria-current="page" class="active sidebar-link">查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqala-doc/query/#构建查询" class="sidebar-link">构建查询</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#投影" class="sidebar-link">投影</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#过滤" class="sidebar-link">过滤</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#表连接" class="sidebar-link">表连接</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#分组" class="sidebar-link">分组</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#排序" class="sidebar-link">排序</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#去重" class="sidebar-link">去重</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#子查询" class="sidebar-link">子查询</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#连接内存中的集合" class="sidebar-link">连接内存中的集合</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#集合操作" class="sidebar-link">集合操作</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/query/#递归查询" class="sidebar-link">递归查询</a></li></ul></li><li><a href="/sqala-doc/expr/" class="sidebar-link">表达式</a></li><li><a href="/sqala-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/sqala-doc/dynamic-query/" class="sidebar-link">动态查询构造</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h1> <p>在配置好元数据之后，我们就可以开始着手构建查询了，sqala的基础查询结构与Scala集合库非常相似：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="构建查询"><a href="#构建查询" class="header-anchor">#</a> 构建查询</h2> <p>sqala的查询使用<code>query</code>方法构建：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>birthday<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c3<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id_number<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c4<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>people<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span>
</code></pre></div><p>在配置好数据库信息之后，查询返回的数据为：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><h2 id="投影"><a href="#投影" class="header-anchor">#</a> 投影</h2> <p>使用<code>map</code>方法进行结果集的投影操作，其对应到SQL的<code>SELECT</code>子句，参数是一个表结构对象映射到<a href="https://wz7982.github.io/sqala-doc/expr/" target="_blank" rel="noopener noreferrer">表达式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>或表达式组成的元组：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span>
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>people<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span>
</code></pre></div><p>查询返回的数据为：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><h2 id="过滤"><a href="#过滤" class="header-anchor">#</a> 过滤</h2> <p>使用<code>filter</code>方法进行条件过滤，其对应到SQL的<code>WHERE</code>子句，参数是一个<code>Boolean</code><a href="https://wz7982.github.io/sqala-doc/expr/" target="_blank" rel="noopener noreferrer">表达式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>people<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span> 
<span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token operator">=</span> ?
</code></pre></div><p><strong>多次调用<code>filter</code>时将会使用AND来连接查询条件。</strong></p> <p>对于动态拼接的条件，sqala提供了<code>filterIf</code>方法，会在第一个参数值为<code>true</code>时使用<code>AND</code>才将条件拼接到查询中：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> name <span class="token operator">=</span> <span class="token string">&quot;小黑&quot;</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filterIf<span class="token punctuation">(</span>id <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span>filterIf<span class="token punctuation">(</span>name<span class="token punctuation">.</span>nonEmpty<span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>name <span class="token operator">==</span> name<span class="token punctuation">)</span>
</code></pre></div><p><strong><code>filter</code>不会改变查询结果类型。</strong></p> <h2 id="表连接"><a href="#表连接" class="header-anchor">#</a> 表连接</h2> <p>sqala支持使用<code>join</code>、<code>leftJoin</code>、<code>rightJoin</code>、<code>fullJoin</code>来处理表连接，并使用<code>on</code>来处理链接条件：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>join<span class="token punctuation">[</span>B<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">==</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>join<span class="token punctuation">[</span>C<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> b<span class="token punctuation">.</span>id <span class="token operator">==</span> c<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p><code>on</code>引用的参数类型为一个由表对象组成的元组，元组项的数量会根据连接的表数量变化。</p> <p>此时返回的结果类型为：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><p>由于外连接会产生额外的空值，因此，sqala可以从表连接的信息中自动推断返回类型，如果我们把上面的查询改为先进行右连接再进行左连接：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>rightJoin<span class="token punctuation">[</span>B<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">==</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>leftJoin<span class="token punctuation">[</span>C<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> b<span class="token punctuation">.</span>id <span class="token operator">==</span> c<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>此时返回的结果类型变成了：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token punctuation">(</span>Option<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">,</span> B<span class="token punctuation">,</span> Option<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><p>这里显式写出了返回类型仅仅是为了演示，sqala会从查询中自动推断出合适的返回类型。</p> <p>我们也可以方便地处理连接自身的情况，比如有一个存储部门树的表对象：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Department<span class="token punctuation">(</span>
    id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>
    parentId<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token builtin">String</span>
<span class="token punctuation">)</span>
</code></pre></div><p>我们可以这样来关联查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>Department<span class="token punctuation">]</span><span class="token punctuation">.</span>leftJoin<span class="token punctuation">[</span>Department<span class="token punctuation">]</span><span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> t2<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> t1<span class="token punctuation">.</span>parentId <span class="token operator">==</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><h2 id="分组"><a href="#分组" class="header-anchor">#</a> 分组</h2> <p>使用<code>groupBy</code>配合聚合函数表达式进行分组操作：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>gender<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> g<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span>p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>birthday<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c3<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>people<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span> 
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span>
</code></pre></div><p>另外可以使用<code>having</code>过滤聚合出的数据：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>gender<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>having<span class="token punctuation">(</span>_ <span class="token keyword">=&gt;</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> g<span class="token punctuation">.</span>_2<span class="token punctuation">,</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span>p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h2> <p>使用<code>sortBy</code>方法进行排序，参数是使用<code>asc</code>或<code>desc</code>方法生成的排序规则，多个<code>sortBy</code>会依次拼接：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id<span class="token punctuation">.</span>asc<span class="token punctuation">)</span><span class="token punctuation">.</span>sortBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name<span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>birthday<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c3<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id_number<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c4<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>people<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span> 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">DESC</span>
</code></pre></div><p><strong><code>sortBy</code>不会改变查询结果类型</strong></p> <h2 id="去重"><a href="#去重" class="header-anchor">#</a> 去重</h2> <p>使用<code>distinct</code>方法来对结果集进行去重：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>distinct
</code></pre></div><h2 id="子查询"><a href="#子查询" class="header-anchor">#</a> 子查询</h2> <p>sqala支持<a href="https://wz7982.github.io/sqala-doc/expr/" target="_blank" rel="noopener noreferrer">表达式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的子查询和<code>JOIN</code>中的表子查询，首先来介绍表达式中的子查询：</p> <p>返回一列数据的子查询可以作为表达式的一部分出现，比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> subQuery <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> max<span class="token punctuation">(</span>p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>birthday <span class="token operator">&lt;</span> subQuery<span class="token punctuation">)</span>
</code></pre></div><p>支持<code>IN</code>、<code>ANY</code>、<code>SOME</code>、<code>ALL</code>、<code>EXISTS</code>等子查询相关谓词：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> subQuery <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

<span class="token keyword">val</span> q1 <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">==</span> any<span class="token punctuation">(</span>subQuery<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q2 <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id<span class="token punctuation">.</span>in<span class="token punctuation">(</span>subQuery<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>需要在表达式左侧使用子查询，可以使用<code>asExpr</code>方法：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> subQuery <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> max<span class="token punctuation">(</span>p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> subQuery<span class="token punctuation">.</span>asExpr <span class="token operator">&gt;</span> p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span>
</code></pre></div><p><code>JOIN</code>中的子查询使用<code>join</code>、<code>leftJoin</code>、<code>rightJoin</code>、<code>fullJoin</code>等方法，传入子查询，此时查询表达式会比较复杂，因此强烈推荐Scala3新的无括号语法，代码会更加简洁：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>leftJoin<span class="token operator">:</span>
        query<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> b <span class="token keyword">=&gt;</span>
            <span class="token punctuation">(</span>b<span class="token punctuation">.</span>x<span class="token punctuation">,</span> b<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>on<span class="token operator">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> q<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
        a<span class="token punctuation">.</span>x <span class="token operator">==</span> q<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>map<span class="token operator">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> q<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> q<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以使用<code>apply</code>方法传入字段下标，来引用对应的字段，这个操作是类型安全的（Scala3的命名元组特性上线后，sqala会改造子查询的用法，使其更易用）。</p> <p>如果需要在子查询表中使用外侧表的字段，这时符合SQL的<code>LATERAL</code>语义，因此我们需要在<code>join</code>等方法名后面添加<code>Lateral</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>leftJoinLateral<span class="token operator">:</span> a <span class="token keyword">=&gt;</span>
        query<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> b <span class="token keyword">=&gt;</span>
            <span class="token punctuation">(</span>b<span class="token punctuation">.</span>x<span class="token punctuation">,</span> b<span class="token punctuation">.</span>y<span class="token punctuation">,</span> a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> a<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>on<span class="token operator">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> q<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
        a<span class="token punctuation">.</span>x <span class="token operator">==</span> q<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>map<span class="token operator">:</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> q<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span>
        <span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> q<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> q<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>使用该类方法时需要注意数据库是否支持此功能，比如MySQL 8.0 版本以下不支持此功能</strong></p> <h2 id="连接内存中的集合"><a href="#连接内存中的集合" class="header-anchor">#</a> 连接内存中的集合</h2> <p>sqala支持表连接中使用内存中的集合，这是使用数据库的<code>VALUES</code>功能实现的：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> list <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span>
    <span class="token punctuation">.</span>joinList<span class="token punctuation">(</span>list<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> l<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">==</span> l<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> l<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span> l<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>x<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>d0_t1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>a<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span> 
    <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
        <span class="token keyword">VALUES</span> <span class="token keyword">ROW</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">ROW</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t1<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">)</span> 
    <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>x<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t1<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span>
</code></pre></div><p><strong>与joinLateral等方法类似，使用时需要注意数据库是否支持此功能</strong></p> <h2 id="集合操作"><a href="#集合操作" class="header-anchor">#</a> 集合操作</h2> <p>sqala支持使用<code>union</code>、<code>unionAll</code>、<code>intersect</code>、<code>intersectAll</code>、<code>except</code>、<code>exceptAll</code>等方法来处理集合查询，比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q1 <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> q2 <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> q1 union q2
</code></pre></div><p>由于<code>UNION ALL</code>与集合拼接语义一致，所以<code>unionAll</code>可以简写成<code>++</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> q1 <span class="token operator">++</span> q2
</code></pre></div><p>处于集合操作两侧的查询，其返回类型必须列数量一致，且类型一一对应，假如有两个查询，分别返回<code>(Option[Int], String, Option[Date])</code>和<code>(Int, Option[String], Date)</code>，这样的两个查询调用集合操作将会返回<code>(Option[Int], Option[String], Option[Date])</code>。</p> <p>与内存中集合互操作时，在方法名后面添加<code>List</code>即可，同样使用<code>VALUES</code>功能实现：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q1 <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> l1 <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;小白&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> q1 unionList l1
</code></pre></div><h2 id="递归查询"><a href="#递归查询" class="header-anchor">#</a> 递归查询</h2> <p>回想一下前文中表连接部分提到的部门表，如果我们想查询一整个部门树，可能需要发出多次查询，所幸，数据库支持<code>CTE(Common Table Expression)</code>功能，我们可以用来构建递归查询，而无需发出多次查询浪费数据库性能，sqala支持使用<code>withRecursive</code>方法创建递归查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> baseQuery <span class="token operator">=</span> query<span class="token punctuation">[</span>Department<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>d <span class="token keyword">=&gt;</span> d<span class="token punctuation">.</span>parentId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>*<span class="token punctuation">)</span>

<span class="token keyword">val</span> cte <span class="token operator">=</span> withRecursive<span class="token punctuation">(</span>baseQuery<span class="token punctuation">)</span><span class="token operator">:</span> q <span class="token keyword">=&gt;</span>
    <span class="token keyword">val</span> unionQuery <span class="token operator">=</span> query<span class="token punctuation">[</span>Department<span class="token punctuation">]</span>
        <span class="token punctuation">.</span>join<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> d<span class="token punctuation">.</span>parentId <span class="token operator">==</span> tmp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> d<span class="token punctuation">.</span>*<span class="token punctuation">)</span>
    q <span class="token operator">++</span> unionQuery
</code></pre></div><p>其生成的SQL（以MySQL方言为例）形如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WITH</span> RECURSIVE <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> 
        <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
        <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>parent_id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
        <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> 
    <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span> 
    <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>parent_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">0</span> 
    <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>     
    <span class="token keyword">SELECT</span> 
        <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
        <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>parent_id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
        <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> 
    <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span> 
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span> <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>d0_t0<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>parent_id<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span>
<span class="token punctuation">)</span> 
<span class="token keyword">SELECT</span> 
    <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> 
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>cte<span class="token punctuation">`</span></span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqala-doc/database/" class="prev">
        数据库交互
      </a></span> <span class="next"><a href="/sqala-doc/expr/">
        表达式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqala-doc/assets/js/app.9bf302b3.js" defer></script><script src="/sqala-doc/assets/js/2.58244656.js" defer></script><script src="/sqala-doc/assets/js/1.6ba70183.js" defer></script><script src="/sqala-doc/assets/js/28.83043ead.js" defer></script>
  </body>
</html>
