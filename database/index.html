<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库交互 | sqala</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="类型安全的Scala3查询库">
    
    <link rel="preload" href="/sqala-doc/assets/css/0.styles.05ece7a7.css" as="style"><link rel="preload" href="/sqala-doc/assets/js/app.9bf302b3.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/2.58244656.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/1.6ba70183.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/23.cac91773.js" as="script"><link rel="prefetch" href="/sqala-doc/assets/js/10.0720960b.js"><link rel="prefetch" href="/sqala-doc/assets/js/11.2a97faa3.js"><link rel="prefetch" href="/sqala-doc/assets/js/12.6b9ed61d.js"><link rel="prefetch" href="/sqala-doc/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/sqala-doc/assets/js/14.3e65117c.js"><link rel="prefetch" href="/sqala-doc/assets/js/15.2d87bde7.js"><link rel="prefetch" href="/sqala-doc/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/sqala-doc/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/sqala-doc/assets/js/18.4c170722.js"><link rel="prefetch" href="/sqala-doc/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/sqala-doc/assets/js/20.10e47ab9.js"><link rel="prefetch" href="/sqala-doc/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/sqala-doc/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/sqala-doc/assets/js/24.28b07f74.js"><link rel="prefetch" href="/sqala-doc/assets/js/25.4285c857.js"><link rel="prefetch" href="/sqala-doc/assets/js/26.6bc8b23d.js"><link rel="prefetch" href="/sqala-doc/assets/js/27.d15bd4b2.js"><link rel="prefetch" href="/sqala-doc/assets/js/28.83043ead.js"><link rel="prefetch" href="/sqala-doc/assets/js/29.6f1587b4.js"><link rel="prefetch" href="/sqala-doc/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/sqala-doc/assets/js/4.45665f8a.js"><link rel="prefetch" href="/sqala-doc/assets/js/5.7098d77a.js"><link rel="prefetch" href="/sqala-doc/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/sqala-doc/assets/js/7.6a854e57.js"><link rel="prefetch" href="/sqala-doc/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/sqala-doc/assets/css/0.styles.05ece7a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqala-doc/" class="home-link router-link-active"><!----> <span class="site-name">sqala</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/sqala-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/sqala-doc/database/" aria-current="page" class="active sidebar-link">数据库交互</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqala-doc/database/#查询数据" class="sidebar-link">查询数据</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#查询条数" class="sidebar-link">查询条数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#分页查询" class="sidebar-link">分页查询</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#执行语句" class="sidebar-link">执行语句</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#事务" class="sidebar-link">事务</a></li></ul></li><li><a href="/sqala-doc/query/" class="sidebar-link">查询</a></li><li><a href="/sqala-doc/expr/" class="sidebar-link">表达式</a></li><li><a href="/sqala-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/sqala-doc/dynamic-query/" class="sidebar-link">动态查询构造</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库交互"><a href="#数据库交互" class="header-anchor">#</a> 数据库交互</h1> <p>为了和数据库交互，在配置好实体类的元数据信息后，我们还需要配置好数据库的连接信息，目前sqala支持创建JDBC上下文管理连接。</p> <p>我们这样来构造一个查询上下文：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DataSource

<span class="token comment">// 任意连接池，比如Hikari、Druid、DBCP、C3P0等</span>
<span class="token keyword">val</span> dataSource<span class="token operator">:</span> DataSource <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>

<span class="token comment">// 第二个参数传入数据库方言</span>
<span class="token comment">// 支持的方言有：</span>
<span class="token comment">// MysqlDialect</span>
<span class="token comment">// PostgresqlDialect</span>
<span class="token comment">// SqliteDialect</span>
<span class="token comment">// OracleDialect</span>
<span class="token comment">// MssqlDialect</span>
<span class="token comment">// DB2Dialect</span>
<span class="token keyword">val</span> db <span class="token operator">=</span> Context<span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> MysqlDialect<span class="token punctuation">)</span>
</code></pre></div><p>然后我们需要配置日志处理器，以便在执行查询时打印出对应的SQL语句，任何类型为<code>String =&gt; Unit</code>的函数都可以作为日志处理器，此处以标准库的<code>println</code>为例，实际使用时可以自行替换成成各种日志框架：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">given</span> Logger <span class="token operator">=</span> Logger<span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>如果不需要打印日志，我们可以这样做：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">given</span> Logger <span class="token operator">=</span> Logger<span class="token punctuation">(</span>_ <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>配置好连接信息之后，就可以连接到数据库执行查询了。但在此之前，我们还需要改造一下前文中的实体类，为其生成反序列化代码：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">case</span> <span class="token keyword">class</span> People<span class="token punctuation">(</span>
    <span class="token annotation punctuation">@autoInc</span> id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> 
    name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> 
    gender<span class="token operator">:</span> Gender<span class="token punctuation">,</span> 
    birthday<span class="token operator">:</span> Date<span class="token punctuation">,</span>
    idNumber<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token keyword">derives</span> Decoder
</code></pre></div><p>我们无需为实体类手工编写反序列化代码，给实体类添加<code>derives Decoder</code>即可自动生成代码，但前提是实体类的字段类型都支持sqala的反序列化操作，如果遇到编译错误，请尝试使用<code>CustomField</code>。</p> <h2 id="查询数据"><a href="#查询数据" class="header-anchor">#</a> 查询数据</h2> <p>使用<code>execute</code>方法查询数据，其返回一个List类型的结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 实际使用时，无需显式写出返回类型，sqala会根据查询表达式推断出返回的数据类型</span>
<span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><h2 id="查询条数"><a href="#查询条数" class="header-anchor">#</a> 查询条数</h2> <p>查询数据条数是一个常用的操作，我们可以使用<code>execute</code>方法配合查询表达式的<code>size</code>方法进行查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>size

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">.</span>head
</code></pre></div><p>为了避免性能浪费，在调用<code>size</code>时，sqala会视情况对传入的查询进行优化，如果查询是一个不包含<code>GROUP BY</code>的<code>SELECT</code>查询，sqala会将<code>SELECT</code>的字段替换成<code>COUNT(*)</code>，并去掉查询中的<code>ORDER BY</code>和<code>LIMIT</code>子句；如果查询不是<code>SELECT</code>语句，或是语句中包含<code>GROUP BY</code>，sqala不会对查询进行优化，并将其作为子查询表使用。</p> <h2 id="分页查询"><a href="#分页查询" class="header-anchor">#</a> 分页查询</h2> <p>使用<code>page</code>方法分页查询，其返回Page类型的结果，Page类型定义如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Page<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>total<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> current<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> size<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> data<span class="token operator">:</span> List<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><code>page</code>的参数分别为：查询语句、页大小、页码、是否需要查询条数（默认为true）：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> Page<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>page<span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>其中最后一个参数控制是否需要查询条数，如果在每次分页查询都查询条数，可能会浪费数据库资源，比如实际使用时我们可以只在第一页查询条数，其他时候返回0：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>

<span class="token keyword">val</span> pageSize <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">val</span> pageNo <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> result<span class="token operator">:</span> Page<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>page<span class="token punctuation">(</span>q<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageNo <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="执行语句"><a href="#执行语句" class="header-anchor">#</a> 执行语句</h2> <p>对于非查询类语句，使用<code>execute</code>方法执行语句，其返回Int类型的结果，含义是受影响行数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>insert<span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>如果我们需要在插入数据之后返回自增主键的值，可以使用<code>executeReturnKey</code>方法，其返回一个Long类型的列表：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> Date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>executeReturnKey<span class="token punctuation">(</span>insert<span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <p><code>transaction</code>方法用来创建一个事务，<code>transaction</code>是一个带有上下文的函数，内部出现异常会回滚事务并抛出异常，如无异常则会返回内部的返回值：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token keyword">try</span>
    db<span class="token punctuation">.</span>transaction<span class="token operator">:</span>
        execute<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        execute<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword">catch</span> <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> <span class="token keyword">throw</span> e
</code></pre></div><p>非常重要的一点是：在<code>transaction</code>内部执行的查询方法，请不要使用<code>db.</code>显式指定数据库连接上下文。</p> <p>利用Scala3的上下文抽象机制，我们可以方便地将事务上下文在不同方法之间传播，而且这个操作是类型安全的：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">def</span> insertPeople<span class="token punctuation">(</span>row<span class="token operator">:</span> People<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> TransactionContext<span class="token punctuation">)</span> <span class="token operator">=</span> executeReturnKey<span class="token punctuation">(</span>insert<span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>toInt

<span class="token keyword">def</span> deletePeople<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> TransactionContext<span class="token punctuation">)</span> <span class="token operator">=</span> execute<span class="token punctuation">(</span>delete<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> insertAndDelete<span class="token punctuation">(</span>row<span class="token operator">:</span> People<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> TransactionContext<span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">val</span> id <span class="token operator">=</span> insertPeople<span class="token punctuation">(</span>row<span class="token punctuation">)</span>
    deletePeople<span class="token punctuation">(</span>id<span class="token punctuation">)</span>

db<span class="token punctuation">.</span>transaction<span class="token operator">:</span>
    insertAndDelete<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
</code></pre></div><p>通过<code>using TransactionContext</code>，将会在需要事务执行的函数上添加事务上下文，如果不在<code>transaction</code>方法内调用，则会产生编译错误，并且标记了<code>using TransactionContext</code>的方法可以在<code>transaction</code>内共享同一个事务：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 编译错误</span>
insertAndDelete<span class="token punctuation">(</span>people<span class="token punctuation">)</span>

<span class="token comment">// 编译通过</span>
db<span class="token punctuation">.</span>transaction<span class="token operator">:</span>
    insertAndDelete<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
</code></pre></div><p>另外，还可以使用<code>transactionWithIsolation</code>方法来指定隔离级别。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqala-doc/metadata/" class="prev">
        元数据配置
      </a></span> <span class="next"><a href="/sqala-doc/query/">
        查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqala-doc/assets/js/app.9bf302b3.js" defer></script><script src="/sqala-doc/assets/js/2.58244656.js" defer></script><script src="/sqala-doc/assets/js/1.6ba70183.js" defer></script><script src="/sqala-doc/assets/js/23.cac91773.js" defer></script>
  </body>
</html>
