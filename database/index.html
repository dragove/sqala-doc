<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库交互 | sqala</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="类型安全的Scala3查询库">
    
    <link rel="preload" href="/sqala-doc/assets/css/0.styles.41638646.css" as="style"><link rel="preload" href="/sqala-doc/assets/js/app.96be3cda.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/2.767acac5.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/1.7485bcf3.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/23.12db8fd2.js" as="script"><link rel="prefetch" href="/sqala-doc/assets/js/10.c454cbf7.js"><link rel="prefetch" href="/sqala-doc/assets/js/11.4c11b429.js"><link rel="prefetch" href="/sqala-doc/assets/js/12.37c67b2d.js"><link rel="prefetch" href="/sqala-doc/assets/js/13.bf4c6df4.js"><link rel="prefetch" href="/sqala-doc/assets/js/14.a15beb18.js"><link rel="prefetch" href="/sqala-doc/assets/js/15.dd179505.js"><link rel="prefetch" href="/sqala-doc/assets/js/16.14fa32d7.js"><link rel="prefetch" href="/sqala-doc/assets/js/17.65f688a3.js"><link rel="prefetch" href="/sqala-doc/assets/js/18.9a514804.js"><link rel="prefetch" href="/sqala-doc/assets/js/19.254801e4.js"><link rel="prefetch" href="/sqala-doc/assets/js/20.1410a88d.js"><link rel="prefetch" href="/sqala-doc/assets/js/21.ea553156.js"><link rel="prefetch" href="/sqala-doc/assets/js/22.ce2cea28.js"><link rel="prefetch" href="/sqala-doc/assets/js/24.410416e3.js"><link rel="prefetch" href="/sqala-doc/assets/js/25.08da704b.js"><link rel="prefetch" href="/sqala-doc/assets/js/26.9367b22d.js"><link rel="prefetch" href="/sqala-doc/assets/js/27.7946b464.js"><link rel="prefetch" href="/sqala-doc/assets/js/28.5e72bf29.js"><link rel="prefetch" href="/sqala-doc/assets/js/29.955fe444.js"><link rel="prefetch" href="/sqala-doc/assets/js/3.25337f94.js"><link rel="prefetch" href="/sqala-doc/assets/js/30.ab9f1f37.js"><link rel="prefetch" href="/sqala-doc/assets/js/31.25a10860.js"><link rel="prefetch" href="/sqala-doc/assets/js/32.1177fae6.js"><link rel="prefetch" href="/sqala-doc/assets/js/33.a01a8fc8.js"><link rel="prefetch" href="/sqala-doc/assets/js/4.0dfa8901.js"><link rel="prefetch" href="/sqala-doc/assets/js/5.28a50498.js"><link rel="prefetch" href="/sqala-doc/assets/js/6.f25848c6.js"><link rel="prefetch" href="/sqala-doc/assets/js/7.3ac2c704.js"><link rel="prefetch" href="/sqala-doc/assets/js/vendors~docsearch.8b826ef6.js">
    <link rel="stylesheet" href="/sqala-doc/assets/css/0.styles.41638646.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqala-doc/" class="home-link router-link-active"><!----> <span class="site-name">sqala</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/sqala-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/sqala-doc/database/" aria-current="page" class="active sidebar-link">数据库交互</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqala-doc/database/#验证数据-可选" class="sidebar-link">验证数据（可选）</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#查询数据" class="sidebar-link">查询数据</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#查询首条数据" class="sidebar-link">查询首条数据</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#查询条数" class="sidebar-link">查询条数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#查询存在性" class="sidebar-link">查询存在性</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#分页查询" class="sidebar-link">分页查询</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#执行语句" class="sidebar-link">执行语句</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#使用对象插入数据" class="sidebar-link">使用对象插入数据</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#使用对象修改数据" class="sidebar-link">使用对象修改数据</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#游标查询" class="sidebar-link">游标查询</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#返回sql" class="sidebar-link">返回SQL</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/database/#事务" class="sidebar-link">事务</a></li></ul></li><li><a href="/sqala-doc/query/" class="sidebar-link">查询</a></li><li><a href="/sqala-doc/native-query/" class="sidebar-link">原生SQL</a></li><li><a href="/sqala-doc/expr/" class="sidebar-link">表达式</a></li><li><a href="/sqala-doc/example/" class="sidebar-link">示例</a></li><li><a href="/sqala-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/sqala-doc/dynamic-query/" class="sidebar-link">动态查询构造</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库交互"><a href="#数据库交互" class="header-anchor">#</a> 数据库交互</h1> <p>为了和数据库交互，在配置好实体类的元数据信息后，我们还需要配置好数据库的连接信息，目前sqala支持创建JDBC上下文管理连接。</p> <p>我们这样来构造一个查询上下文：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>static<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DataSource

<span class="token comment">// 任意连接池，比如Hikari、Druid、DBCP、C3P0等</span>
<span class="token keyword">val</span> dataSource<span class="token operator">:</span> DataSource <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>

<span class="token comment">// 第二个参数传入数据库方言</span>
<span class="token comment">// 支持的方言有：</span>
<span class="token comment">// MysqlDialect</span>
<span class="token comment">// PostgresqlDialect</span>
<span class="token comment">// SqliteDialect</span>
<span class="token comment">// OracleDialect</span>
<span class="token comment">// MssqlDialect</span>
<span class="token comment">// DB2Dialect</span>
<span class="token comment">// H2Dialect</span>
<span class="token keyword">val</span> db <span class="token operator">=</span> JdbcContext<span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> MysqlDialect<span class="token punctuation">)</span>
</code></pre></div><p>然后我们需要配置日志处理器，以便在执行查询时打印出对应的SQL语句，任何类型为<code>String =&gt; Unit</code>的函数都可以作为日志处理器，此处以标准库的<code>println</code>为例，实际使用时可以自行替换成成各种日志框架：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">given</span> Logger <span class="token operator">=</span> Logger<span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>如果不需要打印日志，可以写成：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">given</span> Logger <span class="token operator">=</span> Logger<span class="token punctuation">(</span>_ <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>配置好连接信息之后，就可以连接到数据库执行查询了。</p> <p>我们无需为实体类手工编写反序列化代码，如果遇到编译错误，请尝试使用<code>CustomField</code>。</p> <h2 id="验证数据-可选"><a href="#验证数据-可选" class="header-anchor">#</a> 验证数据（可选）</h2> <p>验证数据是一个<strong>可选步骤</strong>，在配置好一个额外的测试连接信息之后，sqala将在编译期连接到数据库，并验证实体类的正确性。</p> <p>我们首先使用<code>transparent inline given</code>创建测试连接信息：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">transparent</span> <span class="token keyword">inline</span> <span class="token keyword">given</span> JdbcTestConnection <span class="token operator">=</span> JdbcTestConnection<span class="token punctuation">(</span>
    <span class="token string">&quot;Your Url&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Your username&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Your password&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;Driver class name&quot;</span><span class="token punctuation">,</span>
    MysqlDialect <span class="token comment">// 对应的方言</span>
<span class="token punctuation">)</span>
</code></pre></div><p>确保<code>given</code>在作用域中，对需要验证的实体类添加<code>derives ValidateSchema</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Entity<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token keyword">derives</span> ValidateSchema
</code></pre></div><p>如果实体类的定义与数据库中对应的表不符，将会产生编译错误，错误信息为数据库报错。</p> <p><strong>目前暂不支持自定义字段类型的验证。</strong></p> <h2 id="查询数据"><a href="#查询数据" class="header-anchor">#</a> 查询数据</h2> <p>使用<code>fetch</code>方法查询数据，其返回一个List类型的结果：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">// 实际使用无需显式写出返回类型，sqala会根据查询表达式推断出返回的数据类型</span>
<span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>fetch<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><p>我们可以使用<code>fetchTo</code>方法将结果映射到非sqala自动推导出的类型，但可能在运行时返回类型转换错误：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> List<span class="token punctuation">[</span>SomeEntity<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>fetchTo<span class="token punctuation">[</span>SomeEntity<span class="token punctuation">]</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><h2 id="查询首条数据"><a href="#查询首条数据" class="header-anchor">#</a> 查询首条数据</h2> <p><code>find</code>方法返回一个<code>Option</code>类型的结果，即查询命中结果集的首条数据：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> Option<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>find<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><p><code>findTo</code>方法与<code>fetchTo</code>类似：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> Option<span class="token punctuation">[</span>SomeEntity<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>findTo<span class="token punctuation">[</span>SomeEntity<span class="token punctuation">]</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><h2 id="查询条数"><a href="#查询条数" class="header-anchor">#</a> 查询条数</h2> <p>查询数据条数是一个常用的操作，我们可以使用<code>fetchSize</code>方法进行查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>fetchSize<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><p>为了避免性能浪费，在调用<code>fetchSize</code>时，sqala会视情况对传入的查询进行优化，如果查询是一个不包含<code>GROUP BY</code>，以及非<code>DISTINCT</code>的<code>SELECT</code>查询，sqala会将<code>SELECT</code>的字段替换成<code>COUNT(*)</code>，并去掉查询中的<code>ORDER BY</code>和<code>LIMIT</code>子句；如果查询不是<code>SELECT</code>语句，或是语句中包含<code>GROUP BY</code>，或查询是<code>DISTINCT</code>的，sqala不会对查询进行优化，并将其作为子查询表使用。</p> <h2 id="查询存在性"><a href="#查询存在性" class="header-anchor">#</a> 查询存在性</h2> <p>使用<code>fetchExists</code>查询存在性：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>fetchExists<span class="token punctuation">(</span>q<span class="token punctuation">)</span>
</code></pre></div><h2 id="分页查询"><a href="#分页查询" class="header-anchor">#</a> 分页查询</h2> <p>使用<code>page</code>方法分页查询，其返回Page类型的结果，Page类型定义如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Page<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>
    pageTotal<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>  <span class="token comment">// 总页数</span>
    querySize<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token comment">// 查询COUNT(*)返回的条目数</span>
    pageNo<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>     <span class="token comment">// 当前页码</span>
    pageSize<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>   <span class="token comment">// 页大小</span>
    data<span class="token operator">:</span> List<span class="token punctuation">[</span>T<span class="token punctuation">]</span>    <span class="token comment">// 分页数据</span>
<span class="token punctuation">)</span>
</code></pre></div><p><code>page</code>的参数分别为：查询语句、页大小、页码、是否需要查询条数（默认为true）：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> Page<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>page<span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>其中最后一个参数控制是否需要查询条数，如果在每次分页查询都查询条数，可能会浪费数据库资源，比如实际业务中我们可以只在第一页查询条数，其他情况返回0：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>

<span class="token keyword">val</span> pageSize <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">val</span> pageNo <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> Page<span class="token punctuation">[</span>People<span class="token punctuation">]</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>page<span class="token punctuation">(</span>q<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageNo <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="执行语句"><a href="#执行语句" class="header-anchor">#</a> 执行语句</h2> <p>对于非查询类语句，使用<code>execute</code>方法执行语句，其返回Int类型的结果，含义是受影响行数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>insert<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> values <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="使用对象插入数据"><a href="#使用对象插入数据" class="header-anchor">#</a> 使用对象插入数据</h2> <p><code>insert</code>方法可以使用实体对象生成插入语句，并执行返回受影响行数（使用<code>autoInc</code>标记的字段会跳过）：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
</code></pre></div><p><code>insertAndReturn</code>方法可以使用实体对象生成插入语句，并执行后返回实体对象非自增主键字段值和数据库生成自增主键绑定的一个新的实体对象，由于使用<code>autoInc</code>标记的字段会跳过，因此，插入实体类的自增主键字段可以随意填写一个无关的值：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> insertedPeople <span class="token operator">=</span> db<span class="token punctuation">.</span>insertAndReturn<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
</code></pre></div><p><code>insertBatch</code>方法用于批量插入，参数是一个实体对象的<code>List</code>，插入后返回受影响行数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> peopleList <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span> <span class="token operator">::</span> Nil

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>insertBatch<span class="token punctuation">(</span>peopleList<span class="token punctuation">)</span>
</code></pre></div><h2 id="使用对象修改数据"><a href="#使用对象修改数据" class="header-anchor">#</a> 使用对象修改数据</h2> <p><code>update</code>方法可以使用实体对象生成一个按主键字段更新其他字段的更新语句，并执行返回受影响行数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>update<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
</code></pre></div><p>如果想设置为字段值为<code>None</code>时则不更新此字段，则可以传入<code>skipNone = true</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>update<span class="token punctuation">(</span>people<span class="token punctuation">,</span> skipNone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>为了避免生成错误插入，此时如果非主键字段的值全都是None，则不会向数据库发出此更新请求。</p> <p><code>save</code>方法可以使用实体对象生成：按主键是否存在觉得插入或更新的语句：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> people <span class="token operator">=</span> People<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">,</span> Gender<span class="token punctuation">.</span>Male<span class="token punctuation">,</span> LocalDate<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>

<span class="token keyword">val</span> result<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>save<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
</code></pre></div><p>各数据库生成的方言均不同。</p> <h2 id="游标查询"><a href="#游标查询" class="header-anchor">#</a> 游标查询</h2> <p>在需要操作大批量数据的场景中（比如导出数据到文件），如果我们将数据一次性查入到内存，可能会导致内存占用过大，如果采用分页查询，可能会导致效率低下。因此sqala支持了JDBC的游标查询，使用<code>cursorFetch</code>启用游标查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>

db<span class="token punctuation">.</span>cursorFetch<span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">:</span> c <span class="token keyword">=&gt;</span>
    <span class="token comment">// 对数据的操作</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><code>cursorFetch</code>的第一个参数是查询语句，第二个参数是每一批次获取的条目数，可以根据实际情况选用合适的大小。</p> <p>然后传入一个对<strong>每一批次</strong>数据的操作函数，类型为<code>Cursor[T] =&gt; R</code></p> <p><code>Cursor</code>类型的定义为：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Cursor<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>
    batchNo<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>    <span class="token comment">// 批次编码</span>
    batchSize<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>  <span class="token comment">// 批次大小，即cursorFetch的第二个参数</span>
    data<span class="token operator">:</span> List<span class="token punctuation">[</span>T<span class="token punctuation">]</span>    <span class="token comment">// 一批次的数据</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="返回sql"><a href="#返回sql" class="header-anchor">#</a> 返回SQL</h2> <p>使用<code>sql</code>方法返回生成的SQL：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> <span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">=</span> q<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>MysqlDialect<span class="token punctuation">)</span>
</code></pre></div><h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <p><code>transaction</code>方法用来创建一个事务，<code>transaction</code>是一个带有上下文的函数，内部出现异常会回滚事务并抛出异常，如无异常则会返回内部的返回值：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> db<span class="token punctuation">.</span>transaction <span class="token punctuation">{</span>
        execute<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        execute<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    println<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span> println<span class="token punctuation">(</span><span class="token string">&quot;查询错误&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>非常重要的一点是：在<code>transaction</code>内部执行的查询方法，请不要使用<code>db.</code>显式指定数据库连接上下文。</p> <p>利用Scala3的上下文抽象机制，我们可以方便地将事务上下文在不同方法之间传播，而且这个操作是类型安全的：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">def</span> insertPeople<span class="token punctuation">(</span>row<span class="token operator">:</span> People<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> TransactionContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span>
    executeReturnKey<span class="token punctuation">(</span>insert<span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span>toInt

<span class="token keyword">def</span> deletePeople<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> TransactionContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span>
    execute<span class="token punctuation">(</span>delete<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> insertAndDelete<span class="token punctuation">(</span>row<span class="token operator">:</span> People<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> TransactionContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span>
    <span class="token keyword">val</span> id <span class="token operator">=</span> insertPeople<span class="token punctuation">(</span>row<span class="token punctuation">)</span>
    deletePeople<span class="token punctuation">(</span>id<span class="token punctuation">)</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">.</span>transaction <span class="token punctuation">{</span>
        insertAndDelete<span class="token punctuation">(</span>people<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> e<span class="token operator">:</span> Exception <span class="token keyword">=&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过<code>using TransactionContext</code>，将会在需要事务执行的函数上添加事务上下文，如果不在<code>transaction</code>方法内调用，则会产生编译错误，并且标记了<code>using TransactionContext</code>的方法可以在<code>transaction</code>内共享同一个事务。</p> <p>另外，使用<code>transactionWithIsolation</code>方法可以指定事务隔离级别。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqala-doc/metadata/" class="prev">
        元数据配置
      </a></span> <span class="next"><a href="/sqala-doc/query/">
        查询
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqala-doc/assets/js/app.96be3cda.js" defer></script><script src="/sqala-doc/assets/js/2.767acac5.js" defer></script><script src="/sqala-doc/assets/js/1.7485bcf3.js" defer></script><script src="/sqala-doc/assets/js/23.12db8fd2.js" defer></script>
  </body>
</html>
