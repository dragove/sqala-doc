<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>表达式 | sqala</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="类型安全的Scala3查询库">
    
    <link rel="preload" href="/sqala-doc/assets/css/0.styles.41638646.css" as="style"><link rel="preload" href="/sqala-doc/assets/js/app.96be3cda.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/2.767acac5.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/1.7485bcf3.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/26.9367b22d.js" as="script"><link rel="prefetch" href="/sqala-doc/assets/js/10.c454cbf7.js"><link rel="prefetch" href="/sqala-doc/assets/js/11.4c11b429.js"><link rel="prefetch" href="/sqala-doc/assets/js/12.37c67b2d.js"><link rel="prefetch" href="/sqala-doc/assets/js/13.bf4c6df4.js"><link rel="prefetch" href="/sqala-doc/assets/js/14.a15beb18.js"><link rel="prefetch" href="/sqala-doc/assets/js/15.dd179505.js"><link rel="prefetch" href="/sqala-doc/assets/js/16.14fa32d7.js"><link rel="prefetch" href="/sqala-doc/assets/js/17.65f688a3.js"><link rel="prefetch" href="/sqala-doc/assets/js/18.9a514804.js"><link rel="prefetch" href="/sqala-doc/assets/js/19.254801e4.js"><link rel="prefetch" href="/sqala-doc/assets/js/20.1410a88d.js"><link rel="prefetch" href="/sqala-doc/assets/js/21.ea553156.js"><link rel="prefetch" href="/sqala-doc/assets/js/22.ce2cea28.js"><link rel="prefetch" href="/sqala-doc/assets/js/23.12db8fd2.js"><link rel="prefetch" href="/sqala-doc/assets/js/24.410416e3.js"><link rel="prefetch" href="/sqala-doc/assets/js/25.08da704b.js"><link rel="prefetch" href="/sqala-doc/assets/js/27.7946b464.js"><link rel="prefetch" href="/sqala-doc/assets/js/28.5e72bf29.js"><link rel="prefetch" href="/sqala-doc/assets/js/29.955fe444.js"><link rel="prefetch" href="/sqala-doc/assets/js/3.25337f94.js"><link rel="prefetch" href="/sqala-doc/assets/js/30.ab9f1f37.js"><link rel="prefetch" href="/sqala-doc/assets/js/31.25a10860.js"><link rel="prefetch" href="/sqala-doc/assets/js/32.1177fae6.js"><link rel="prefetch" href="/sqala-doc/assets/js/33.a01a8fc8.js"><link rel="prefetch" href="/sqala-doc/assets/js/4.0dfa8901.js"><link rel="prefetch" href="/sqala-doc/assets/js/5.28a50498.js"><link rel="prefetch" href="/sqala-doc/assets/js/6.f25848c6.js"><link rel="prefetch" href="/sqala-doc/assets/js/7.3ac2c704.js"><link rel="prefetch" href="/sqala-doc/assets/js/vendors~docsearch.8b826ef6.js">
    <link rel="stylesheet" href="/sqala-doc/assets/css/0.styles.41638646.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqala-doc/" class="home-link router-link-active"><!----> <span class="site-name">sqala</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/sqala-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/sqala-doc/database/" class="sidebar-link">数据库交互</a></li><li><a href="/sqala-doc/query/" class="sidebar-link">查询</a></li><li><a href="/sqala-doc/native-query/" class="sidebar-link">原生SQL</a></li><li><a href="/sqala-doc/expr/" aria-current="page" class="active sidebar-link">表达式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#字段" class="sidebar-link">字段</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#值" class="sidebar-link">值</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#逻辑、关系运算" class="sidebar-link">逻辑、关系运算</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#导入given" class="sidebar-link">导入given</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#多列比较" class="sidebar-link">多列比较</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#数值运算" class="sidebar-link">数值运算</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#函数" class="sidebar-link">函数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#聚合函数" class="sidebar-link">聚合函数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#窗口函数" class="sidebar-link">窗口函数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#条件表达式" class="sidebar-link">条件表达式</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#json操作" class="sidebar-link">JSON操作</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#时间操作" class="sidebar-link">时间操作</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#类型转换" class="sidebar-link">类型转换</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#数组谓词" class="sidebar-link">数组谓词</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#自定义二元运算符" class="sidebar-link">自定义二元运算符</a></li></ul></li><li><a href="/sqala-doc/example/" class="sidebar-link">示例</a></li><li><a href="/sqala-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/sqala-doc/dynamic-query/" class="sidebar-link">动态查询构造</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="表达式"><a href="#表达式" class="header-anchor">#</a> 表达式</h1> <p>为了更好地使用sqala处理业务，我们最好对sqala的表达式有一些了解。</p> <p>sqala中包含了一个SQL语法树，并在编译期读取Scala本身的语法树，转换到SQL语法树，因此，sqala拥有强大的表达力。</p> <h2 id="字段"><a href="#字段" class="header-anchor">#</a> 字段</h2> <p>字段是最基本的表达式之一，我们在查询构建中使用的字段就是字段表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// id是一个字段类型的表达式</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="值"><a href="#值" class="header-anchor">#</a> 值</h2> <p>除了字段外，值表达式也是最基本的表达式，比如一些需求需要把一个固定的值作为结果的一列：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>id <span class="token operator">=</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> c1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> c2 <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="逻辑、关系运算"><a href="#逻辑、关系运算" class="header-anchor">#</a> 逻辑、关系运算</h2> <p>除了字段和值之外，构造查询最常用的就是逻辑运算与关系运算表达式，它常用于查询表达式的<code>filter</code>、<code>on</code>、<code>having</code>等方法中。</p> <p>sqala支持以下的符号运算符：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应SQL运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>==</code></td> <td style="text-align:center;"><code>=</code></td></tr> <tr><td style="text-align:center;"><code>!=</code></td> <td style="text-align:center;"><code>&lt;&gt;</code></td></tr> <tr><td style="text-align:center;"><code>&gt;</code></td> <td style="text-align:center;"><code>&gt;</code></td></tr> <tr><td style="text-align:center;"><code>&gt;=</code></td> <td style="text-align:center;"><code>&gt;=</code></td></tr> <tr><td style="text-align:center;"><code>&lt;</code></td> <td style="text-align:center;"><code>&lt;</code></td></tr> <tr><td style="text-align:center;"><code>&lt;=</code></td> <td style="text-align:center;"><code>&lt;=</code></td></tr> <tr><td style="text-align:center;"><code>&amp;&amp;</code></td> <td style="text-align:center;"><code>AND</code></td></tr> <tr><td style="text-align:center;"><code>||</code></td> <td style="text-align:center;"><code>OR</code></td></tr></tbody></table> <p>比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> name <span class="token operator">=</span> <span class="token string">&quot;小黑&quot;</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> id <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name <span class="token operator">==</span> name<span class="token punctuation">)</span>
</code></pre></div><p>如果<code>==</code>或<code>!=</code>的右侧值是<code>None</code>，则对应SQL的<code>IS NULL</code>和<code>IS NOT NULL</code></p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// a.x IS NULL </span>
<span class="token keyword">val</span> q1 <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">==</span> None<span class="token punctuation">)</span>

<span class="token comment">// a.x IS NOT NULL </span>
<span class="token keyword">val</span> q2 <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">!=</span> None<span class="token punctuation">)</span>
</code></pre></div><p>为了使<code>!=</code>与编程语言语义一致，sqala会进行语义优化：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// a.x &lt;&gt; 1 OR a.x IS NULL</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>运算符的右侧不仅可以是普通的值，也可以是另一个表达式，比如它可以放在<code>ON</code>条件里：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">==</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>值表达式也可以轻易地放在一个二元运算的左侧：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token number">1</span> <span class="token operator">==</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>除了这些符号组成的运算符，sqala还支持一些非符号的运算符：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应SQL运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>in</code></td> <td style="text-align:center;"><code>IN</code></td></tr> <tr><td style="text-align:center;"><code>between</code></td> <td style="text-align:center;"><code>BETWEEN</code></td></tr> <tr><td style="text-align:center;"><code>like</code></td> <td style="text-align:center;"><code>LIKE</code></td></tr> <tr><td style="text-align:center;"><code>contains</code></td> <td style="text-align:center;"><code>LIKE '%xxx%'</code></td></tr> <tr><td style="text-align:center;"><code>startsWith</code></td> <td style="text-align:center;"><code>LIKE 'xxx%'</code></td></tr> <tr><td style="text-align:center;"><code>endsWith</code></td> <td style="text-align:center;"><code>LIKE '%xxx'</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> ids <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id<span class="token punctuation">.</span>in<span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">&quot;小%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><code>in</code>运算在传入一个空列表时，为避免生成错误SQL，此谓词会被优化成<code>FALSE</code>。</p> <p><code>in</code>运算可以也传入一个类型相符的表达式元组，而非值列表：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id<span class="token punctuation">.</span>in<span class="token punctuation">(</span>a<span class="token punctuation">.</span>id<span class="token punctuation">,</span> a<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>使用<code>!</code>创建一元逻辑运算：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>对<code>in</code>、<code>between</code>、<code>like</code>、<code>exists</code>等运算符使用逻辑运算<code>!</code>，会生成对应的<code>NOT IN</code>、<code>NOT BETWEEN</code>、<code>NOT LIKE</code>、<code>NOT EXISTS</code>运算符，而非一元运算。</p> <h2 id="导入given"><a href="#导入given" class="header-anchor">#</a> 导入given</h2> <p>如果需要比较的表达式有不同的数据类型，比如<code>Int</code>和<code>Option[Long]</code>的比较、<code>LocalDateTime</code>和<code>String</code>的比较等；</p> <p>或是使用<code>like</code>、<code>between</code>等运算符。</p> <p>需要导入：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>static<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span>given</span>
</code></pre></div><p>方能使表达式成立。</p> <p>这些<code>given</code>实例均引用了一个<code>QueryContext</code>的上下文参数，因此不会在<code>queryContext</code>作用域之外使用时通过编译，不会污染其他非查询构造代码。</p> <h2 id="多列比较"><a href="#多列比较" class="header-anchor">#</a> 多列比较</h2> <p>sqala也允许多列同时参与关系运算：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q1 <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q2 <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>in<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;小黑&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;小白&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> q3 <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>in<span class="token punctuation">(</span>query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="数值运算"><a href="#数值运算" class="header-anchor">#</a> 数值运算</h2> <p>sqala支持以下数值运算符：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应SQL运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>+</code></td> <td style="text-align:center;"><code>+</code></td></tr> <tr><td style="text-align:center;"><code>-</code></td> <td style="text-align:center;"><code>-</code></td></tr> <tr><td style="text-align:center;"><code>*</code></td> <td style="text-align:center;"><code>*</code></td></tr> <tr><td style="text-align:center;"><code>/</code></td> <td style="text-align:center;"><code>/</code></td></tr> <tr><td style="text-align:center;"><code>%</code></td> <td style="text-align:center;"><code>%</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span> 
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre></div><p>以及一元运算<code>+</code>和<code>-</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span> 
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token operator">-</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><h2 id="函数"><a href="#函数" class="header-anchor">#</a> 函数</h2> <p>sqala内置了一些常用函数</p> <table><thead><tr><th style="text-align:center;">函数名称</th> <th style="text-align:center;">对应SQL函数</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>coalesce</code></td> <td style="text-align:center;"><code>COALESCE</code></td></tr> <tr><td style="text-align:center;"><code>ifnull</code></td> <td style="text-align:center;"><code>COALESCE</code></td></tr> <tr><td style="text-align:center;"><code>nullif</code></td> <td style="text-align:center;"><code>NULLIF</code></td></tr> <tr><td style="text-align:center;"><code>abs</code></td> <td style="text-align:center;"><code>ABS</code></td></tr> <tr><td style="text-align:center;"><code>ceil</code></td> <td style="text-align:center;"><code>CEIL</code></td></tr> <tr><td style="text-align:center;"><code>floor</code></td> <td style="text-align:center;"><code>FLOOR</code></td></tr> <tr><td style="text-align:center;"><code>round</code></td> <td style="text-align:center;"><code>ROUND</code></td></tr> <tr><td style="text-align:center;"><code>power</code></td> <td style="text-align:center;"><code>POWER</code></td></tr> <tr><td style="text-align:center;"><code>concat</code></td> <td style="text-align:center;"><code>CONCAT</code></td></tr> <tr><td style="text-align:center;"><code>substring</code></td> <td style="text-align:center;"><code>SUBSTRING</code></td></tr> <tr><td style="text-align:center;"><code>replace</code></td> <td style="text-align:center;"><code>REPLACE</code></td></tr> <tr><td style="text-align:center;"><code>trim</code></td> <td style="text-align:center;"><code>TRIM</code></td></tr> <tr><td style="text-align:center;"><code>upper</code></td> <td style="text-align:center;"><code>UPPER</code></td></tr> <tr><td style="text-align:center;"><code>lower</code></td> <td style="text-align:center;"><code>LOWER</code></td></tr> <tr><td style="text-align:center;"><code>now()</code></td> <td style="text-align:center;"><code>NOW()</code></td></tr></tbody></table> <p>由于各种数据库的函数的差异极大，sqala没有内置其他的SQL函数，我们同样可以使用<code>sqlFunction</code>注解创建函数。</p> <p>我们以MySQL的<code>LEFT</code>函数为例：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token annotation punctuation">@sqlFunction</span><span class="token punctuation">(</span><span class="token string">&quot;LEFT&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> left<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
</code></pre></div><p>注解<code>sqlFunction</code>标记函数为SQL函数，注解的参数是SQL函数名称，由于这类方法仅在编译期读取并转换为SQL表达式，因此无需编写实际的方法体。</p> <p>这样我们就可以使用它构建查询了：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> left<span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>函数类型的表达式当然也可以嵌套调用：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> left<span class="token punctuation">(</span>left<span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="聚合函数"><a href="#聚合函数" class="header-anchor">#</a> 聚合函数</h2> <p>sqala内置了几个常用的SQL标准聚合函数：</p> <table><thead><tr><th style="text-align:center;">函数名称</th> <th style="text-align:center;">对应SQL函数</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>count()</code></td> <td style="text-align:center;"><code>COUNT(*)</code></td></tr> <tr><td style="text-align:center;"><code>countDistinct(expr)</code></td> <td style="text-align:center;"><code>COUNT(DISTINCT x)</code></td></tr> <tr><td style="text-align:center;"><code>sum(expr)</code></td> <td style="text-align:center;"><code>SUM(x)</code></td></tr> <tr><td style="text-align:center;"><code>max(expr)</code></td> <td style="text-align:center;"><code>MAX(x)</code></td></tr> <tr><td style="text-align:center;"><code>min(expr)</code></td> <td style="text-align:center;"><code>MIN(x)</code></td></tr> <tr><td style="text-align:center;"><code>avg(expr)</code></td> <td style="text-align:center;"><code>AVG(x)</code></td></tr> <tr><td style="text-align:center;"><code>anyValue(expr)</code></td> <td style="text-align:center;"><code>ANY_VALUE(x)</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s <span class="token operator">=</span> sum<span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>聚合函数也可以和其他表达式组合：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sum<span class="token punctuation">(</span>p<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>聚合函数不可嵌套调用：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// 编译错误</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> sum<span class="token punctuation">(</span>sum<span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="特殊聚合函数"><a href="#特殊聚合函数" class="header-anchor">#</a> 特殊聚合函数</h3> <h4 id="percentiledisc和percentilecont"><a href="#percentiledisc和percentilecont" class="header-anchor">#</a> percentileDisc和percentileCont</h4> <p>sqala支持两个特殊的数值聚合函数<code>percentileDisc</code>和<code>percentileCont</code>，对应到数据库的<code>PERCENTILE_DIST</code>和<code>PERCENTILE_CONT</code>函数。</p> <p>用法如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>
        <span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
            percentileDisc<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> withinGroup <span class="token operator">=</span> p<span class="token punctuation">.</span>id<span class="token punctuation">.</span>asc<span class="token punctuation">)</span>
</code></pre></div><p>第一个参数接收一个<code>Double</code>值；</p> <p>第二个参数<code>withinGroup</code>接收一个排序规则，排序字段必须是数值类型。</p> <p><strong>MySQL、SQLite等数据库暂不支持此函数。</strong></p> <h4 id="stringagg"><a href="#stringagg" class="header-anchor">#</a> stringAgg</h4> <p>sqala支持特殊的字符串聚合函数<code>stringAgg</code>和<code>groupConcat</code>，两个方法的实质内容完全一致，作用是将字符串一次拼接，用法如下：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>
        <span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
            stringAgg<span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">.</span>asc<span class="token punctuation">)</span>
</code></pre></div><p>第一个参数是一个字符串表达式；</p> <p>第二个参数是<code>String</code>值，为分隔符；</p> <p>后续是若干个排序规则，可省略。</p> <p>sqala对此函数进行了特殊方言适配，规则如下：</p> <p>在PostgreSQL或SQLServer中，生成<code>STRING_AGG</code>函数；</p> <p>在MySQL中，生成<code>GROUP_CONCAT</code>函数，并将分隔符置于<code>SEPARATOR</code>关键字之后；</p> <p>在SQLite中，生成<code>GROUP_CONCAT</code>函数；</p> <p>在Oracle或DB2中，生成<code>LISTAGG</code>函数，并将排序规则放入<code>WITHIN GROUP</code>子句中。</p> <h4 id="grouping"><a href="#grouping" class="header-anchor">#</a> grouping</h4> <p>sqala支持<code>grouping</code>聚合函数，对应到数据库的<code>GROUPING</code>函数，用于区分哪些表达式参与了当前分组，在<code>GROUP BY CUBE</code>等复杂分组下且被分组表达式可能有空值的场景十分有用，其参数为若干个分组表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span>
        <span class="token punctuation">.</span>groupBy p <span class="token keyword">=&gt;</span>
            <span class="token punctuation">(</span>name <span class="token operator">=</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>map<span class="token operator">:</span> <span class="token punctuation">(</span>g<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> 
            grouping<span class="token punctuation">(</span>g<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre></div><p>如果参数不是分组表达式，则会产生编译错误。</p> <p><strong>请注意：对于<code>GROUPING</code>函数，MySQL数据库限制其必须在<code>GROUP BY ROLLUP</code>或<code>GROUP BY GROUPING SETS</code>的查询中使用；SQLite数据库不支持此函数，sqala不对以上情况进行编译期检查。</strong></p> <h3 id="自定义聚合函数"><a href="#自定义聚合函数" class="header-anchor">#</a> 自定义聚合函数</h3> <p>除了sqala内置的聚合函数外，我们可以轻易地自定义聚合函数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>static<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token annotation punctuation">@sqlAgg</span><span class="token punctuation">(</span><span class="token string">&quot;FUNCTION_NAME&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> functionDistinct<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> sortBy<span class="token operator">:</span> Sort<span class="token punctuation">[</span><span class="token operator">?</span><span class="token punctuation">]</span><span class="token punctuation">,</span> withinGroup<span class="token operator">:</span> Sort<span class="token punctuation">[</span><span class="token operator">?</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>
</code></pre></div><p>与自定义函数类似，但使用<code>sqlAgg</code>注解定义SQL聚合函数。</p> <p>自定义聚合函数遵循以下约定：</p> <div class="language- extra-class"><pre><code>1. 如果参数名为`sortBy`，则会生成聚合函数的`ORDER BY`子句。
2. 如果参数名为`withinGroup`，则会生成聚合函数的`WITHIN GROUP`子句。
3. 如果参数名为`filter`，则会生成聚合函数的`FILTER`子句。
4. 如果方法名以`Distinct`结尾，则对应到`DISTINCT`的聚合函数。
</code></pre></div><h2 id="窗口函数"><a href="#窗口函数" class="header-anchor">#</a> 窗口函数</h2> <p>sqala支持下面几个分析函数：</p> <table><thead><tr><th style="text-align:center;">函数名称</th> <th style="text-align:center;">对应SQL函数</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>rank()</code></td> <td style="text-align:center;"><code>RANK()</code></td></tr> <tr><td style="text-align:center;"><code>denseRank()</code></td> <td style="text-align:center;"><code>DENSE_RANK()</code></td></tr> <tr><td style="text-align:center;"><code>percentRank()</code></td> <td style="text-align:center;"><code>PERCENT_RANK()</code></td></tr> <tr><td style="text-align:center;"><code>rowNumber()</code></td> <td style="text-align:center;"><code>ROW_NUMBER()</code></td></tr> <tr><td style="text-align:center;"><code>lag</code></td> <td style="text-align:center;"><code>LAG(x, n, default)</code></td></tr> <tr><td style="text-align:center;"><code>lead</code></td> <td style="text-align:center;"><code>LEAD(x, n, default)</code></td></tr> <tr><td style="text-align:center;"><code>ntile(n)</code></td> <td style="text-align:center;"><code>NTILE(n)</code></td></tr> <tr><td style="text-align:center;"><code>firstValue</code></td> <td style="text-align:center;"><code>FIRST_VALUE(x)</code></td></tr> <tr><td style="text-align:center;"><code>lastValue</code></td> <td style="text-align:center;"><code>LAST_VALUE(x)</code></td></tr> <tr><td style="text-align:center;"><code>nthValue</code></td> <td style="text-align:center;"><code>NTH_VALUE(x)</code></td></tr> <tr><td style="text-align:center;"><code>cumeDist()</code></td> <td style="text-align:center;"><code>CUME_DIST()</code></td></tr></tbody></table> <p>在分析函数或聚合函数之后调用<code>over</code>，可以生成窗口函数表达式，可以使用<code>partitionBy</code>及<code>sortBy</code>，<code>partitionBy</code>的参数是若干表达式，<code>sortBy</code>的参数是若干表达式生成的排序规则：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        rank<span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partitionBy <span class="token punctuation">(</span>p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span> sortBy <span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">.</span>asc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>窗口函数的参数可以为空：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        rank<span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>窗口函数的参数可以仅有<code>sortBy</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        rank<span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>sortBy <span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">.</span>asc<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>sqala支持窗口函数的框架，使用<code>rowsBetween</code>、<code>rangeBetween</code>、<code>groupsBetween</code>生成一个框架，以上方法均有两个参数，可能为：</p> <table><thead><tr><th style="text-align:center;">参数</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>currentRow</code></td></tr> <tr><td style="text-align:center;"><code>unboundedPreceding</code></td></tr> <tr><td style="text-align:center;"><code>unboundedFollowing</code></td></tr> <tr><td style="text-align:center;"><code>n.preceding</code></td></tr> <tr><td style="text-align:center;"><code>n.following</code></td></tr></tbody></table> <p>比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span> 
        rank<span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token punctuation">(</span>partitionBy <span class="token punctuation">(</span>p<span class="token punctuation">.</span>birthday<span class="token punctuation">)</span> sortBy <span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">.</span>asc<span class="token punctuation">)</span> rowsBetween <span class="token punctuation">(</span>currentRow<span class="token punctuation">,</span> <span class="token number">1</span> preceding<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们可以使用<code>sqlWindow</code>注解创建窗口函数，规则与<code>sqlFunction</code>一致。</p> <h2 id="条件表达式"><a href="#条件表达式" class="header-anchor">#</a> 条件表达式</h2> <p>sqala将Scala3的<code>if</code>表达式翻译为SQL的<code>CASE WHEN</code>表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>gender <span class="token operator">==</span> Gender<span class="token punctuation">.</span>Male then <span class="token number">1</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>gender <span class="token operator">==</span> Gender<span class="token punctuation">.</span>Female then <span class="token number">2</span>
        <span class="token keyword">else</span> <span class="token number">0</span>
</code></pre></div><p>可以在<code>then</code>中返回<code>Option</code>类型的值：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>gender <span class="token operator">==</span> Gender<span class="token punctuation">.</span>Male then Some<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>gender <span class="token operator">==</span> Gender<span class="token punctuation">.</span>Female then Some<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span> None
</code></pre></div><p>将Scala3的<code>match</code>表达式翻译为SQL的<code>CASE x WHEN</code>表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span>
        p<span class="token punctuation">.</span>gender <span class="token keyword">match</span>
            <span class="token keyword">case</span> Gender<span class="token punctuation">.</span>Male <span class="token keyword">=&gt;</span> <span class="token number">1</span>
            <span class="token keyword">case</span> _ <span class="token keyword">=&gt;</span> <span class="token number">0</span>
</code></pre></div><p><strong>暂不支持带有if守卫的match表达式。</strong></p> <h2 id="json操作"><a href="#json操作" class="header-anchor">#</a> JSON操作</h2> <p>sqala支持<code>-&gt;</code>和<code>-&gt;&gt;</code>两个JSON操作符，语义与MySQL和PostgreSQL一致：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> a <span class="token keyword">=&gt;</span> 
        a<span class="token punctuation">.</span>x <span class="token operator">-&gt;</span> <span class="token number">0</span> <span class="token operator">-&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;a&quot;</span>
</code></pre></div><p>对于JSON操作，需要将字段类型指定为<code>sqala.dsl.Json</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>static<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span><span class="token operator">*</span>

<span class="token keyword">case</span> <span class="token keyword">class</span> A<span class="token punctuation">(</span>x<span class="token operator">:</span> Json<span class="token punctuation">)</span>
</code></pre></div><p>其定义为<code>opaque type Json = String</code>。我们可以使用其<code>toString</code>方法转换为字符串。</p> <h2 id="时间操作"><a href="#时间操作" class="header-anchor">#</a> 时间操作</h2> <p>我们可以使用<code>interval</code>方法来对时间进行操作：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> a <span class="token keyword">=&gt;</span> 
        a<span class="token punctuation">.</span>date <span class="token operator">+</span> interval<span class="token punctuation">(</span><span class="token number">1</span> day<span class="token punctuation">)</span> <span class="token operator">+</span> interval<span class="token punctuation">(</span><span class="token number">1</span> month<span class="token punctuation">)</span>
</code></pre></div><p><code>interval</code>的第一个参数是<code>Double</code>类型，第二个参数是时间单位，sqala支持以下时间单位：</p> <table><thead><tr><th style="text-align:center;">单位</th> <th style="text-align:center;">含义</th></tr></thead> <tbody><tr><td style="text-align:center;">year</td> <td style="text-align:center;">年</td></tr> <tr><td style="text-align:center;">month</td> <td style="text-align:center;">月</td></tr> <tr><td style="text-align:center;">week</td> <td style="text-align:center;">周</td></tr> <tr><td style="text-align:center;">day</td> <td style="text-align:center;">日</td></tr> <tr><td style="text-align:center;">hour</td> <td style="text-align:center;">时</td></tr> <tr><td style="text-align:center;">minute</td> <td style="text-align:center;">分</td></tr> <tr><td style="text-align:center;">second</td> <td style="text-align:center;">秒</td></tr></tbody></table> <p>sqala会在生成SQL时自动进行方言转换，比如在SQLServer中会将其转换成<code>DATEADD</code>函数，在SQLite中会将其转换成<code>DATETIME</code>函数，其他数据库将会生成不同的<code>INTERVAL</code>表达式方言。</p> <p>sqala支持字符串插值器<code>timestamp</code>和<code>date</code>，将字符串转变为数据库的时间字面量，对应的类型分别为<code>LocalDateTime</code>和<code>LocalDate</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> time1 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">timestamp</span><span class="token string">&quot;2020-01-01 00:00:00&quot;</span></span>

<span class="token keyword">val</span> time2 <span class="token operator">=</span> <span class="token string-interpolation"><span class="token id function">date</span><span class="token string">&quot;2020-01-01&quot;</span></span>

<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>date1 <span class="token operator">==</span> time1 <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>date2 <span class="token operator">==</span> time2<span class="token punctuation">)</span>
</code></pre></div><p>在Sqlite和SQLServer中会分别转变为日期函数和<code>CAST</code>表达式，其他数据库则会生成时间字面量。</p> <p>我们可以使用<code>extract</code>取出时间的某个部分：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> a <span class="token keyword">=&gt;</span> 
        extract<span class="token punctuation">(</span>a<span class="token punctuation">.</span>date year<span class="token punctuation">)</span>
</code></pre></div><p>SQLServer中会将其转换成<code>DATEPART</code>函数，其他的数据库会生成<code>EXTRACT</code>表达式。</p> <p>可以使用<code>extract</code>操作取出时间差值的某个部分：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> 
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> a <span class="token keyword">=&gt;</span> 
        extract<span class="token punctuation">(</span>a<span class="token punctuation">.</span>date1 <span class="token operator">-</span> a<span class="token punctuation">.</span>date2 day<span class="token punctuation">)</span>
</code></pre></div><h2 id="类型转换"><a href="#类型转换" class="header-anchor">#</a> 类型转换</h2> <p>我们可以使用<code>as</code>方法将表达式转换类型：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> a <span class="token keyword">=&gt;</span> 
        a<span class="token punctuation">.</span>x<span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span>
</code></pre></div><p>sqala会自动进行数据库方言适配。</p> <h2 id="数组谓词"><a href="#数组谓词" class="header-anchor">#</a> 数组谓词</h2> <p>sqala支持<code>any</code>和<code>all</code>两个操作配合集合，作为谓词使用，以PostgreSQL查询为例，比如我们有：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> Task<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> userIds<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
</code></pre></div><p>其中<code>userIds</code>字段是使用<code>,</code>分隔的用户ID列表，我们想查询某个用户的所有任务，可以先自定义SQL函数<code>stringToArray</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token annotation punctuation">@sqlFunction</span><span class="token punctuation">(</span><span class="token string">&quot;STRING_TO_ARRAY&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> stringToArray<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> compileTimeOnly
</code></pre></div><p>然后我们可以使用<code>any</code>查询：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> userId<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span> <span class="token comment">// 假设是外界传参</span>
<span class="token keyword">val</span> userIdString <span class="token operator">=</span> userId<span class="token punctuation">.</span>toString

<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>Task<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>t <span class="token keyword">=&gt;</span> userIdString <span class="token operator">==</span> any<span class="token punctuation">(</span>stringToArray<span class="token punctuation">(</span>t<span class="token punctuation">.</span>userIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>我们也可以把<code>in</code>谓词变为<code>any</code>数组谓词：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x<span class="token punctuation">.</span>in<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>等价于：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">==</span> any<span class="token punctuation">(</span>List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>需要注意的是，虽然数组是SQL标准语法，但目前只有PostgreSQL和H2等少数数据库支持此语法。</strong></p> <h2 id="自定义二元运算符"><a href="#自定义二元运算符" class="header-anchor">#</a> 自定义二元运算符</h2> <p>sqala支持自定义非标准二元运算符，以MySQL的<code>RLIKE</code>为例：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">extension</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@sqlBinaryOperator</span><span class="token punctuation">(</span><span class="token string">&quot;RLIKE&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> rlike<span class="token punctuation">(</span>y<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">using</span> QueryContext<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> compileTimeOnly

<span class="token keyword">val</span> q <span class="token operator">=</span> queryContext<span class="token operator">:</span>
    query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x<span class="token punctuation">.</span>rlike<span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqala-doc/native-query/" class="prev">
        原生SQL
      </a></span> <span class="next"><a href="/sqala-doc/example/">
        示例
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqala-doc/assets/js/app.96be3cda.js" defer></script><script src="/sqala-doc/assets/js/2.767acac5.js" defer></script><script src="/sqala-doc/assets/js/1.7485bcf3.js" defer></script><script src="/sqala-doc/assets/js/26.9367b22d.js" defer></script>
  </body>
</html>
