<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>表达式 | sqala</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="类型安全的Scala3查询库">
    
    <link rel="preload" href="/sqala-doc/assets/css/0.styles.05ece7a7.css" as="style"><link rel="preload" href="/sqala-doc/assets/js/app.9bf302b3.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/2.58244656.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/1.6ba70183.js" as="script"><link rel="preload" href="/sqala-doc/assets/js/25.4285c857.js" as="script"><link rel="prefetch" href="/sqala-doc/assets/js/10.0720960b.js"><link rel="prefetch" href="/sqala-doc/assets/js/11.2a97faa3.js"><link rel="prefetch" href="/sqala-doc/assets/js/12.6b9ed61d.js"><link rel="prefetch" href="/sqala-doc/assets/js/13.ebfb1f42.js"><link rel="prefetch" href="/sqala-doc/assets/js/14.3e65117c.js"><link rel="prefetch" href="/sqala-doc/assets/js/15.2d87bde7.js"><link rel="prefetch" href="/sqala-doc/assets/js/16.9ca9aae8.js"><link rel="prefetch" href="/sqala-doc/assets/js/17.3dbcb51f.js"><link rel="prefetch" href="/sqala-doc/assets/js/18.4c170722.js"><link rel="prefetch" href="/sqala-doc/assets/js/19.d8afd0ae.js"><link rel="prefetch" href="/sqala-doc/assets/js/20.10e47ab9.js"><link rel="prefetch" href="/sqala-doc/assets/js/21.0ad1d6a3.js"><link rel="prefetch" href="/sqala-doc/assets/js/22.b7c97fbe.js"><link rel="prefetch" href="/sqala-doc/assets/js/23.cac91773.js"><link rel="prefetch" href="/sqala-doc/assets/js/24.28b07f74.js"><link rel="prefetch" href="/sqala-doc/assets/js/26.6bc8b23d.js"><link rel="prefetch" href="/sqala-doc/assets/js/27.d15bd4b2.js"><link rel="prefetch" href="/sqala-doc/assets/js/28.83043ead.js"><link rel="prefetch" href="/sqala-doc/assets/js/29.6f1587b4.js"><link rel="prefetch" href="/sqala-doc/assets/js/3.bc6bba9e.js"><link rel="prefetch" href="/sqala-doc/assets/js/4.45665f8a.js"><link rel="prefetch" href="/sqala-doc/assets/js/5.7098d77a.js"><link rel="prefetch" href="/sqala-doc/assets/js/6.0c0a0f39.js"><link rel="prefetch" href="/sqala-doc/assets/js/7.6a854e57.js"><link rel="prefetch" href="/sqala-doc/assets/js/vendors~docsearch.5e19b665.js">
    <link rel="stylesheet" href="/sqala-doc/assets/css/0.styles.05ece7a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/sqala-doc/" class="home-link router-link-active"><!----> <span class="site-name">sqala</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/sqala-doc/metadata/" class="sidebar-link">元数据配置</a></li><li><a href="/sqala-doc/database/" class="sidebar-link">数据库交互</a></li><li><a href="/sqala-doc/query/" class="sidebar-link">查询</a></li><li><a href="/sqala-doc/expr/" aria-current="page" class="active sidebar-link">表达式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#字段" class="sidebar-link">字段</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#值" class="sidebar-link">值</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#逻辑、关系运算" class="sidebar-link">逻辑、关系运算</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#数值运算" class="sidebar-link">数值运算</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#聚合函数" class="sidebar-link">聚合函数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#函数" class="sidebar-link">函数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#窗口函数" class="sidebar-link">窗口函数</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#case" class="sidebar-link">CASE</a></li><li class="sidebar-sub-header"><a href="/sqala-doc/expr/#json操作符" class="sidebar-link">JSON操作符</a></li></ul></li><li><a href="/sqala-doc/update/" class="sidebar-link">增删改</a></li><li><a href="/sqala-doc/dynamic-query/" class="sidebar-link">动态查询构造</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="表达式"><a href="#表达式" class="header-anchor">#</a> 表达式</h1> <p>为了更好地使用sqala处理业务，我们最好对sqala的表达式有一些了解。</p> <p>sqala中包含了一个SQL语法树，并在上层封装出了一个<code>Expr</code>类型，它有不同的项，比如：字段、二元运算、聚合函数等，而这些项很多也接收<code>Expr</code>类型的参数，来组合成新的表达式，因此，sqala拥有强大的抽象能力，通过表达式的组合，我们几乎可以写出任何合法的SQL语句，而无需使用容易出错的原生SQL。</p> <h2 id="字段"><a href="#字段" class="header-anchor">#</a> 字段</h2> <p>字段是最基本的表达式之一，我们在查询构建中使用的字段就是字段表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// id是一个字段类型的表达式</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>使用方法<code>*</code>快速将一个查询类型变为引用其所有字段的形式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">case</span> <span class="token keyword">class</span> A<span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token comment">// 查询返回List[A]</span>
<span class="token keyword">val</span> q1 <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span>

<span class="token comment">// 查询返回List[(Int, String)]</span>
<span class="token keyword">val</span> q2 <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>*<span class="token punctuation">)</span>
</code></pre></div><p><code>*</code>方法仅仅用于改变查询类型，以适应子查询等需要引用查询字段的情况，<strong>生成的SQL语句没有变化</strong>。</p> <h2 id="值"><a href="#值" class="header-anchor">#</a> 值</h2> <p>除了字段外，值表达式也是最基本的表达式，比如一些需求需要把一个固定的值作为结果的一列，此时我们可以使用<code>asExpr</code>方法将值转换为表达式：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">1.</span>asExpr<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">.</span>asExpr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="逻辑、关系运算"><a href="#逻辑、关系运算" class="header-anchor">#</a> 逻辑、关系运算</h2> <p>除了字段和值之外，构造查询最常用的就是逻辑运算与关系运算表达式，它常用于查询表达式的<code>filter</code>、<code>on</code>、<code>having</code>等方法中。</p> <p>sqala支持以下的符号运算符：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应SQL运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>==</code></td> <td style="text-align:center;"><code>=</code></td></tr> <tr><td style="text-align:center;"><code>!=</code></td> <td style="text-align:center;"><code>&lt;&gt;</code></td></tr> <tr><td style="text-align:center;"><code>&gt;</code></td> <td style="text-align:center;"><code>&gt;</code></td></tr> <tr><td style="text-align:center;"><code>&gt;=</code></td> <td style="text-align:center;"><code>&gt;=</code></td></tr> <tr><td style="text-align:center;"><code>&lt;</code></td> <td style="text-align:center;"><code>&lt;</code></td></tr> <tr><td style="text-align:center;"><code>&lt;=</code></td> <td style="text-align:center;"><code>&lt;=</code></td></tr> <tr><td style="text-align:center;"><code>&amp;&amp;</code></td> <td style="text-align:center;"><code>AND</code></td></tr> <tr><td style="text-align:center;"><code>||</code></td> <td style="text-align:center;"><code>OR</code></td></tr> <tr><td style="text-align:center;"><code>^</code></td> <td style="text-align:center;"><code>XOR</code></td></tr></tbody></table> <p>比如：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> id <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">val</span> name <span class="token operator">=</span> <span class="token string">&quot;小黑&quot;</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> id <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name <span class="token operator">==</span> name<span class="token punctuation">)</span>
</code></pre></div><p>使用这些运算符就如同语言内置的一样。</p> <p>运算符的右侧不仅可以是普通的值，也可以是另一个表达式，比如它可以放在<code>ON</code>条件里：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">[</span>B<span class="token punctuation">]</span><span class="token punctuation">.</span>on<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">==</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>如果需要把值写在运算的左侧，可以使用<code>asExpr</code>方法：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token number">1.</span>asExpr <span class="token operator">==</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>需要注意的是，sqala没有直接支持SQL的<code>IS NULL</code>和<code>IS NOT NULL</code>，但是在使用<code>==</code>或<code>!=</code>将<code>Option</code>类型的字段表达式与<code>None</code>进行比较时，则会生成<code>IS NULL</code>和<code>IS NOT NULL</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// a.x IS NULL</span>
<span class="token keyword">val</span> q1 <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">==</span> None<span class="token punctuation">)</span>

<span class="token comment">// a.x IS NOT NULL</span>
<span class="token keyword">val</span> q2 <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">!=</span> None<span class="token punctuation">)</span>
</code></pre></div><p>我们知道，数据库的可空字段，如果使用<code>&lt;&gt;</code>运算符和值比较，查询出的数据中不会包含空值的行，为了与常规编程语言语义一致，sqala会在<code>Option</code>类型的字段和非None的值进行<code>!=</code>比较的时候进行优化：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token comment">// a.x &lt;&gt; 'a' OR a.x IS NULL</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">!=</span> Some<span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>除了这些符号组成的运算符，sqala还支持一些非符号的运算符：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应SQL运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>in</code></td> <td style="text-align:center;"><code>IN</code></td></tr> <tr><td style="text-align:center;"><code>notIn</code></td> <td style="text-align:center;"><code>NOT IN</code></td></tr> <tr><td style="text-align:center;"><code>between</code></td> <td style="text-align:center;"><code>BETWEEN</code></td></tr> <tr><td style="text-align:center;"><code>notBetween</code></td> <td style="text-align:center;"><code>NOT BETWEEN</code></td></tr> <tr><td style="text-align:center;"><code>like</code></td> <td style="text-align:center;"><code>LIKE</code></td></tr> <tr><td style="text-align:center;"><code>notLike</code></td> <td style="text-align:center;"><code>NOT LIKE</code></td></tr> <tr><td style="text-align:center;"><code>contains</code></td> <td style="text-align:center;"><code>LIKE '%xxx%'</code></td></tr> <tr><td style="text-align:center;"><code>startsWith</code></td> <td style="text-align:center;"><code>LIKE 'xxx%'</code></td></tr> <tr><td style="text-align:center;"><code>endsWith</code></td> <td style="text-align:center;"><code>LIKE '%xxx'</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> ids <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id<span class="token punctuation">.</span>in<span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>name<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">&quot;小%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>另外还支持一元逻辑运算<code>!</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token operator">!</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="数值运算"><a href="#数值运算" class="header-anchor">#</a> 数值运算</h2> <p>sqala支持以下数值运算符：</p> <table><thead><tr><th style="text-align:center;">运算符名称</th> <th style="text-align:center;">对应SQL运算符</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>+</code></td> <td style="text-align:center;"><code>+</code></td></tr> <tr><td style="text-align:center;"><code>-</code></td> <td style="text-align:center;"><code>-</code></td></tr> <tr><td style="text-align:center;"><code>*</code></td> <td style="text-align:center;"><code>*</code></td></tr> <tr><td style="text-align:center;"><code>/</code></td> <td style="text-align:center;"><code>/</code></td></tr> <tr><td style="text-align:center;"><code>%</code></td> <td style="text-align:center;"><code>%</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> p<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre></div><p>以及一元运算<code>+</code>和<code>-</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token operator">-</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><h2 id="聚合函数"><a href="#聚合函数" class="header-anchor">#</a> 聚合函数</h2> <p>sqala内置了几个常用的SQL标准聚合函数：</p> <table><thead><tr><th style="text-align:center;">函数名称</th> <th style="text-align:center;">对应SQL函数</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>count()</code></td> <td style="text-align:center;"><code>COUNT(*)</code></td></tr> <tr><td style="text-align:center;"><code>countDistinct(expr)</code></td> <td style="text-align:center;"><code>COUNT(DISTINCT x)</code></td></tr> <tr><td style="text-align:center;"><code>sum(expr)</code></td> <td style="text-align:center;"><code>SUM(x)</code></td></tr> <tr><td style="text-align:center;"><code>max(expr)</code></td> <td style="text-align:center;"><code>MAX(x)</code></td></tr> <tr><td style="text-align:center;"><code>min(expr)</code></td> <td style="text-align:center;"><code>MIN(x)</code></td></tr> <tr><td style="text-align:center;"><code>avg(expr)</code></td> <td style="text-align:center;"><code>AVG(x)</code></td></tr></tbody></table> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sum<span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>聚合函数也可以和其他表达式组合：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sum<span class="token punctuation">(</span>p<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="函数"><a href="#函数" class="header-anchor">#</a> 函数</h2> <p>由于各种数据库的函数的差异极大，sqala没有内置SQL函数，但是我们可以通过<code>Expr</code>的子项<code>Func</code>来支持各种SQL函数，<code>Func</code>接收两个参数，第一个是<code>String</code>类型的函数名，第二个是参数列表，它是<code>Expr</code>的<code>List</code>。</p> <p>我们以MySQL的<code>LEFT</code>函数为例：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">def</span> left<span class="token punctuation">(</span>expr<span class="token operator">:</span> Expr<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token operator">=</span> Func<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;LEFT&quot;</span><span class="token punctuation">,</span> List<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> n<span class="token punctuation">.</span>asExpr<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这样我们就可以使用它构建查询了：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> left<span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>函数类型的表达式当然也可以嵌套调用：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> left<span class="token punctuation">(</span>left<span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="窗口函数"><a href="#窗口函数" class="header-anchor">#</a> 窗口函数</h2> <p>sqala支持下面几个分析函数：</p> <table><thead><tr><th style="text-align:center;">函数名称</th> <th style="text-align:center;">对应SQL函数</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>rank()</code></td> <td style="text-align:center;"><code>RANK()</code></td></tr> <tr><td style="text-align:center;"><code>denseRank()</code></td> <td style="text-align:center;"><code>DENSE_RANK()</code></td></tr> <tr><td style="text-align:center;"><code>rowNumber()</code></td> <td style="text-align:center;"><code>ROW_NUMBER()</code></td></tr> <tr><td style="text-align:center;"><code>lag</code></td> <td style="text-align:center;"><code>LAG(x, n, default)</code></td></tr> <tr><td style="text-align:center;"><code>lead</code></td> <td style="text-align:center;"><code>LEAD(x, n, default)</code></td></tr></tbody></table> <p>在分析函数或聚合函数之后调用<code>over</code>，可以生成窗口函数表达式，可以使用<code>partitionBy</code>及<code>orderBy</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>p <span class="token keyword">=&gt;</span> rank<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over partitionBy p<span class="token punctuation">.</span>birthday orderBy p<span class="token punctuation">.</span>name<span class="token punctuation">.</span>asc<span class="token punctuation">)</span>
</code></pre></div><h2 id="case"><a href="#case" class="header-anchor">#</a> CASE</h2> <p>使用<code>case</code>、<code>when</code>、<code>then</code>、<code>else</code>、<code>end</code>来构建<code>CASE</code>表达式，由于<code>case</code>、<code>then</code>、<code>else</code>是Scala3的关键字，所以调用的时候需要添加反引号，使用<code>CASE</code>表达式时，推荐导入<code>import scala.language.postfixOps</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span>
    `<span class="token keyword">case</span>` when p<span class="token punctuation">.</span>gender <span class="token operator">==</span> Gender<span class="token punctuation">.</span>Male `then` <span class="token number">1</span> `<span class="token keyword">else</span>` <span class="token number">0</span> end
</code></pre></div><p>由于<code>Expr</code>强大的组合能力，<code>CASE</code>自然也可以传入聚合函数：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>People<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token operator">:</span> p <span class="token keyword">=&gt;</span>
    count<span class="token punctuation">(</span>`<span class="token keyword">case</span>` when p<span class="token punctuation">.</span>gender <span class="token operator">==</span> Gender<span class="token punctuation">.</span>Male `then` <span class="token number">1</span> `<span class="token keyword">else</span>` None end<span class="token punctuation">)</span>
</code></pre></div><h2 id="json操作符"><a href="#json操作符" class="header-anchor">#</a> JSON操作符</h2> <p>sqala支持<code>-&gt;</code>和<code>-&gt;&gt;</code>两个JSON操作符，语义与MySQL和PostgreSQL一致，由于<code>-&gt;</code>与Scala标准库构建二元组的方法名相同，为了避免冲突，我们需要<code>import sqala.compiletime.Expr.given</code>：</p> <div class="language-scala extra-class"><pre class="language-scala"><code><span class="token keyword">import</span> <span class="token namespace">sqala<span class="token punctuation">.</span>dsl<span class="token punctuation">.</span></span>Expr<span class="token punctuation">.</span><span class="token keyword">given</span>

<span class="token keyword">val</span> q <span class="token operator">=</span> query<span class="token punctuation">[</span>A<span class="token punctuation">]</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>a <span class="token keyword">=&gt;</span> a<span class="token punctuation">.</span>x <span class="token operator">-&gt;</span> <span class="token number">0</span> <span class="token operator">-&gt;</span><span class="token operator">&gt;</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/sqala-doc/query/" class="prev">
        查询
      </a></span> <span class="next"><a href="/sqala-doc/update/">
        增删改
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/sqala-doc/assets/js/app.9bf302b3.js" defer></script><script src="/sqala-doc/assets/js/2.58244656.js" defer></script><script src="/sqala-doc/assets/js/1.6ba70183.js" defer></script><script src="/sqala-doc/assets/js/25.4285c857.js" defer></script>
  </body>
</html>
